name: Screenshot Manager CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # é™çš„è§£æžãƒ»ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
  lint:
    runs-on: ubuntu-latest
    name: ðŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    steps:
    - uses: actions/checkout@v4
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆç¢ºèª (Black)
      run: black --check --diff src/ test*.py
    
    - name: ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚½ãƒ¼ãƒˆç¢ºèª (isort)  
      run: isort --check-only --diff src/ test*.py
    
    - name: æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ (flake8)
      run: flake8 src/ test*.py --max-line-length=88 --ignore=E203,W503
    
    - name: åž‹ãƒã‚§ãƒƒã‚¯ (mypy)
      run: mypy src/ --ignore-missing-imports || true

  # å˜ä½“ãƒ†ã‚¹ãƒˆãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
  test:
    runs-on: ubuntu-latest
    name: ðŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    needs: lint
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Python ${{ matrix.python-version }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Playwrightä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install playwright
        playwright install chromium --with-deps
    
    - name: å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        python -m pytest tests/ -v --cov=src/ --cov-report=xml
    
    - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        export DISPLAY=:99
        python test_phase24_integration.py
    
    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security:
    runs-on: ubuntu-latest
    name: ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    needs: lint
    steps:
    - uses: actions/checkout@v4
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (bandit)
      run: bandit -r src/ -f json -o bandit-report.json || true
    
    - name: ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (safety)
      run: safety check --json --output safety-report.json || true
    
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  performance:
    runs-on: ubuntu-latest
    name: âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
    needs: test
    steps:
    - uses: actions/checkout@v4
    
    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install memory-profiler psutil
    
    - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        python -c "
        import asyncio
        from src.utils.performance_monitor import PerformanceMonitor
        
        async def perf_test():
            monitor = PerformanceMonitor()
            await monitor.start_monitoring(interval=1.0)
            await asyncio.sleep(5)
            stats = monitor.get_performance_summary()
            print(f'CPUä½¿ç”¨çŽ‡: {stats[\"resource_usage\"][\"avg_cpu_percent\"]}%')
            print(f'ãƒ¡ãƒ¢ãƒªä½¿ç”¨çŽ‡: {stats[\"resource_usage\"][\"avg_memory_percent\"]}%')
            await monitor.stop_monitoring()
            
        asyncio.run(perf_test())
        "

  # ãƒªãƒªãƒ¼ã‚¹æº–å‚™
  release:
    runs-on: ubuntu-latest
    name: ðŸ“¦ ãƒªãƒªãƒ¼ã‚¹æº–å‚™
    needs: [test, security, performance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆç”Ÿæˆ
      id: release_notes
      run: |
        # å‰å›žã®ã‚¿ã‚°ã‹ã‚‰ä»Šå›žã¾ã§ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "åˆå›žãƒªãƒªãƒ¼ã‚¹")
        echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
        
        # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆç”Ÿæˆ
        echo "# Screenshot Manager Release" > release_notes.md
        echo "" >> release_notes.md
        echo "## å¤‰æ›´å†…å®¹" >> release_notes.md
        if [ "$LAST_TAG" != "åˆå›žãƒªãƒªãƒ¼ã‚¹" ]; then
          git log --pretty=format:"- %s" ${LAST_TAG}..HEAD >> release_notes.md
        else
          git log --pretty=format:"- %s" >> release_notes.md
        fi
    
    - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³è‡ªå‹•ç”Ÿæˆ
      id: version
      run: |
        # ã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
        VERSION=$(date +"%Y.%m.%d")-$(git rev-parse --short HEAD)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
    
    - name: GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Screenshot Manager v${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false

  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ (æœ¬ç•ªç’°å¢ƒå‘ã‘)
  deploy:
    runs-on: ubuntu-latest
    name: ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
    needs: release
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
    - uses: actions/checkout@v4
    
    - name: æœ¬ç•ªç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
      run: |
        mkdir -p deploy/
        cat > deploy/docker-compose.prod.yml << 'EOF'
        version: '3.8'
        services:
          screenshot-manager:
            build: 
              context: .
              dockerfile: Dockerfile
            environment:
              - ENV=production
              - LOG_LEVEL=INFO
            volumes:
              - ./logs:/app/logs
              - ./screenshots:/app/screenshots
              - ./config:/app/config
            ports:
              - "8080:8080"
            restart: unless-stopped
            healthcheck:
              test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health')"]
              interval: 30s
              timeout: 10s
              retries: 3
        EOF
    
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ Screenshot Manager ãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ!"
        echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ needs.release.outputs.version }}"
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"