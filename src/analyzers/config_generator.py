#!/usr/bin/env python3
"""
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½
æ¤œå‡ºã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’åŸºã«ã€æœ€é©ãªç›£è¦–è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
"""

import json
import yaml
import logging
from pathlib import Path
from typing import Dict, Any, Optional
from datetime import datetime

from ..detectors.project_detector import ProjectInfo, ProjectDetector

class ConfigGenerator:
    """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•ç”Ÿæˆ"""
    
    def __init__(self, logger=None):
        self.logger = logger or logging.getLogger(__name__)
        self.templates_path = Path(__file__).parent.parent.parent / "config" / "templates" / "project_templates.json"
        self.templates = self._load_templates()
    
    def _load_templates(self) -> Dict[str, Any]:
        """ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€"""
        try:
            with open(self.templates_path, 'r', encoding='utf-8') as f:
                templates = json.load(f)
            self.logger.info(f"âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: {len(templates)}ç¨®é¡")
            return templates
        except Exception as e:
            self.logger.error(f"âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return {}
    
    def generate_config(self, project_info: ProjectInfo, custom_settings: Dict = None) -> Dict[str, Any]:
        """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’åŸºã«è¨­å®šã‚’ç”Ÿæˆ"""
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
        template = self.templates.get(project_info.framework)
        if not template:
            self.logger.warning(f"âš ï¸ {project_info.framework}ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚")
            template = self._get_default_template()
        
        # ãƒ™ãƒ¼ã‚¹è¨­å®šã‚’ä½œæˆ
        config = {
            "# Generated by Screenshot Manager": f"Auto-generated on {datetime.now().isoformat()}",
            "project": {
                "name": project_info.name,
                "framework": project_info.framework,
                "language": project_info.language,
                "path": str(project_info.path),
                "dev_command": project_info.dev_command or template["project"]["dev_command"],
                "build_command": project_info.build_command or template["project"]["build_command"],
                "port": project_info.default_port or template["project"]["port"],
                "package_manager": project_info.package_manager,
                "confidence": project_info.confidence
            }
        }
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šã‚’ãƒãƒ¼ã‚¸
        for section in ["monitoring", "testing", "capture"]:
            if section in template:
                config[section] = template[section].copy()
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®èª¿æ•´
        config = self._customize_config(config, project_info)
        
        # ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚’ãƒãƒ¼ã‚¸
        if custom_settings:
            config = self._merge_configs(config, custom_settings)
        
        self.logger.info(f"âœ… {project_info.framework}ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
        return config
    
    def _get_default_template(self) -> Dict[str, Any]:
        """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿”ã™"""
        return {
            "project": {
                "framework": "Generic",
                "dev_command": "npm start",
                "build_command": "npm run build",
                "port": 3000
            },
            "monitoring": {
                "watch_files": ["src/**/*", "public/**/*"],
                "ignore_patterns": ["node_modules/**", ".git/**"],
                "capture_triggers": ["startup", "code_change"],
                "debounce_ms": 2000
            },
            "testing": {
                "browsers": ["chrome"],
                "viewports": {
                    "desktop": [1920, 1080],
                    "tablet": [768, 1024],
                    "mobile": [375, 667]
                },
                "pages_to_test": [{"path": "/", "name": "Home"}]
            },
            "capture": {
                "wait_before_capture": 2000,
                "full_page": True,
                "error_selectors": [".error", ".alert-danger"]
            }
        }
    
    def _customize_config(self, config: Dict[str, Any], project_info: ProjectInfo) -> Dict[str, Any]:
        """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è¨­å®šèª¿æ•´"""
        
        # ãƒãƒ¼ãƒˆè¨­å®šã®èª¿æ•´
        if project_info.default_port:
            config["project"]["port"] = project_info.default_port
        
        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«å¿œã˜ãŸã‚³ãƒãƒ³ãƒ‰èª¿æ•´
        if project_info.package_manager == "yarn":
            config["project"]["dev_command"] = config["project"]["dev_command"].replace("npm run", "yarn")
            config["project"]["build_command"] = config["project"]["build_command"].replace("npm run", "yarn")
        elif project_info.package_manager == "pnpm":
            config["project"]["dev_command"] = config["project"]["dev_command"].replace("npm run", "pnpm")
            config["project"]["build_command"] = config["project"]["build_command"].replace("npm run", "pnpm")
        
        # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å›ºæœ‰ã®èª¿æ•´
        if project_info.framework == "Django":
            # Djangoãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€manage.pyã®å­˜åœ¨ç¢ºèª
            if (project_info.path / "manage.py").exists():
                config["project"]["dev_command"] = "python manage.py runserver"
        
        elif project_info.framework == "Flask":
            # Flaskãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€app.pyã®å­˜åœ¨ç¢ºèª
            if (project_info.path / "app.py").exists():
                config["project"]["dev_command"] = "python app.py"
            elif (project_info.path / "main.py").exists():
                config["project"]["dev_command"] = "python main.py"
        
        # TypeScriptãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
        if (project_info.path / "tsconfig.json").exists():
            config["project"]["language"] = "TypeScript"
            if "monitoring" in config:
                # TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›£è¦–å¯¾è±¡ã«è¿½åŠ 
                watch_files = config["monitoring"].get("watch_files", [])
                ts_patterns = [pattern.replace(".js", ".ts").replace(".jsx", ".tsx") for pattern in watch_files]
                config["monitoring"]["watch_files"] = list(set(watch_files + ts_patterns))
        
        return config
    
    def _merge_configs(self, base_config: Dict[str, Any], custom_config: Dict[str, Any]) -> Dict[str, Any]:
        """è¨­å®šã‚’ãƒãƒ¼ã‚¸"""
        def deep_merge(dict1, dict2):
            result = dict1.copy()
            for key, value in dict2.items():
                if key in result and isinstance(result[key], dict) and isinstance(value, dict):
                    result[key] = deep_merge(result[key], value)
                else:
                    result[key] = value
            return result
        
        return deep_merge(base_config, custom_config)
    
    def save_config(self, config: Dict[str, Any], project_path: Path, format: str = "yaml") -> Path:
        """è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜"""
        
        if format.lower() == "yaml":
            config_file = project_path / ".screenshot-manager.yaml"
            try:
                with open(config_file, 'w', encoding='utf-8') as f:
                    yaml.dump(config, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
                self.logger.info(f"âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ: {config_file}")
                return config_file
            except Exception as e:
                self.logger.error(f"âŒ YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
                raise
        
        else:  # JSON
            config_file = project_path / ".screenshot-manager.json"
            try:
                with open(config_file, 'w', encoding='utf-8') as f:
                    json.dump(config, f, indent=2, ensure_ascii=False)
                self.logger.info(f"âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ: {config_file}")
                return config_file
            except Exception as e:
                self.logger.error(f"âŒ JSONè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
                raise
    
    def generate_and_save(self, project_path: Path, custom_settings: Dict = None, format: str = "yaml") -> Optional[Path]:
        """ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œå‡ºã—ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆãƒ»ä¿å­˜"""
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º
        detector = ProjectDetector(logger=self.logger)
        project_info = detector.detect_project(project_path)
        
        if not project_info:
            self.logger.error(f"âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ: {project_path}")
            return None
        
        # è¨­å®šç”Ÿæˆ
        config = self.generate_config(project_info, custom_settings)
        
        # ä¿å­˜
        try:
            config_file = self.save_config(config, project_path, format)
            return config_file
        except Exception as e:
            self.logger.error(f"âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå¤±æ•—: {e}")
            return None
    
    def update_existing_config(self, project_path: Path, updates: Dict[str, Any]) -> bool:
        """æ—¢å­˜ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°"""
        
        config_files = [
            project_path / ".screenshot-manager.yaml",
            project_path / ".screenshot-manager.json"
        ]
        
        # æ—¢å­˜ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
        existing_config = None
        config_file = None
        file_format = "yaml"
        
        for cf in config_files:
            if cf.exists():
                config_file = cf
                file_format = "yaml" if cf.suffix == ".yaml" else "json"
                break
        
        if not config_file:
            self.logger.warning("æ—¢å­˜ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚")
            return self.generate_and_save(project_path) is not None
        
        # æ—¢å­˜è¨­å®šã‚’èª­ã¿è¾¼ã¿
        try:
            if file_format == "yaml":
                with open(config_file, 'r', encoding='utf-8') as f:
                    existing_config = yaml.safe_load(f)
            else:
                with open(config_file, 'r', encoding='utf-8') as f:
                    existing_config = json.load(f)
        except Exception as e:
            self.logger.error(f"âŒ æ—¢å­˜è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return False
        
        # è¨­å®šã‚’ãƒãƒ¼ã‚¸
        updated_config = self._merge_configs(existing_config, updates)
        
        # ä¿å­˜
        try:
            self.save_config(updated_config, project_path, file_format)
            return True
        except Exception as e:
            self.logger.error(f"âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
            return False

def main():
    """ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"""
    logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
    
    generator = ConfigGenerator()
    
    # ãƒ†ã‚¹ãƒˆç”¨Reactãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è¨­å®šç”Ÿæˆ
    test_project_path = Path.cwd() / "test_react_project"
    
    if test_project_path.exists():
        print("ğŸ”§ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...")
        
        config_file = generator.generate_and_save(test_project_path)
        
        if config_file:
            print(f"âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”ŸæˆæˆåŠŸ: {config_file}")
            
            # ç”Ÿæˆã•ã‚ŒãŸè¨­å®šã®å†…å®¹ã‚’è¡¨ç¤º
            with open(config_file, 'r', encoding='utf-8') as f:
                content = f.read()
            print("\nğŸ“„ ç”Ÿæˆã•ã‚ŒãŸè¨­å®šå†…å®¹:")
            print(content)
        else:
            print("âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå¤±æ•—")
    else:
        print("âŒ ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

if __name__ == "__main__":
    main()